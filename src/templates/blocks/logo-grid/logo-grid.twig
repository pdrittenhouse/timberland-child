{#
/**
 * Block Name:
 *
 * This is the template that displays the  block.
 */
#}

{#{% if is_preview %}#}
{#<p>Some editor instructions here.</p>#}
{#{% endif %}#}

{#{{ block['className'] }}#}
{#{{ block['align'] ? 'align-' ~ block['align'] }}#}
{#{{ block['align_text']}}#}
{#{{ block['align_content'] }}#}
{#{{ block['full_height'] }}#}

{# Parent Block Data #}
{# ACF <= v.5.9 #}
{#{% set parent = function('get_parent_block', block['id'], block['name']) %}#}
{# ACF >= v.6.0 #}
{#{{ parent_block_data['data'] }}#}
{# Block Context #}
{#{{ block_context['acf/fields'] }}#}

{% set block_classes = block_classes|default([])|merge([
  'logo-grid-block',
  block['className']
]) | sort | join(' ') | trim %}

{% set block_attributes = block_attributes|default([])|merge([
]) | sort | join(' ') | trim %}

<div class="{{ block_classes }}" {{ block_attributes }}>
  {% embed '@atoms/grid/_grid.tpl.twig' with {
    container: false,
    grid_other_classes: 'logo-grid',
  } %}
    {% block column_1 %}
      {% if fields.title %}
      <h4 class="logo-grid--title">{{ fields.title }}</h4>
      {% endif %}
      {% if fields.intro %}
      <div class="logo-grid--intro">{{ fields.intro }}</div>
      {% endif %}
      <div class="logo-grid--wrapper {{ fields.grayscale == true ? 'grayscale-images' }}">
        {% if fields.logos %}
          {% for logo in fields.logos %}
            {# Generate srcset using optimal fallback chain #}
            {% if logo.logo['image_type'] == 'file' and logo.logo['image']['id'] %}
              {% set logo_image_id = logo.logo['image']['id'] %}
              {% set logo_image_srcset = null %}
              {% set logo_image_sizes = null %}

              {# Try cached srcset first (fastest - post meta lookup) #}
              {% set cached_srcset = function('timberland_get_cached_srcset', logo_image_id, 'logo') %}
              {% if cached_srcset %}
                {% set logo_image_srcset = cached_srcset.srcset %}
                {% set logo_image_sizes = cached_srcset.sizes %}
              {% else %}
                {# Fallback to WordPress function if cache miss #}
                {% set logo_image_srcset = function('wp_get_attachment_image_srcset', logo_image_id, 'logo') %}
                {% set logo_image_sizes = function('wp_get_attachment_image_sizes', logo_image_id, 'logo') %}
              {% endif %}

              {# Fallback to ACF sizes array if WordPress function failed #}
              {% if not logo_image_srcset and logo.logo['image']['sizes'] %}
                {% set srcset_parts = [] %}
                {% for size_name, size_url in logo.logo['image']['sizes'] %}
                  {% if size_name matches '/^[a-z]/' and size_url matches '/^http/' %}
                    {% set width_key = size_name ~ '-width' %}
                    {% if logo.logo['image']['sizes'][width_key] %}
                      {% set srcset_parts = srcset_parts|merge([size_url ~ ' ' ~ logo.logo['image']['sizes'][width_key] ~ 'w']) %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% if srcset_parts|length > 0 %}
                  {% set logo_image_srcset = srcset_parts|join(', ') %}
                  {% set logo_image_sizes = '(max-width: 768px) 100vw, 250px' %}
                {% endif %}
              {% endif %}

              {# Final fallback to TimberImage (heaviest - only if other methods failed) #}
              {% if not logo_image_srcset %}
                {% set logo_image_obj = TimberImage(logo_image_id) %}
                {% set logo_image_srcset = logo_image_obj.srcset %}
                {% set logo_image_sizes = '(max-width: 768px) 100vw, 250px' %}
              {% endif %}
            {% endif %}

            <div class="logo-grid--item">
              {% include "@atoms/image/_image.tpl.twig" with {
                variant: 'primary',
                src: logo.logo['image_type'] == 'file' and logo.logo['image']['sizes'] and logo.logo['image']['sizes']['logo'] ? logo.logo['image']['sizes']['logo'] : (logo.logo['image_type'] == 'file' ? logo.logo['image']['url'] : logo.logo['image_type'] == 'url' ? logo.logo['image_url']),
                srcset: logo_image_srcset ? logo_image_srcset : false,
                sizes: logo_image_sizes ? logo_image_sizes : false,
                alt: logo.logo['image_type'] == 'file' ? logo.logo['image']['alt'],
                size: 'logo',
                width: logo.width ? logo.width ~ 'px',
                height: logo.height ? logo.height ~ 'px',
                image_classes: [
                  'logo-grid--image',
                  logo.name
                ],
              } %}
            </div>
          {% endfor %}
        {% endif %}        
      </div>
    {% endblock %}
  {% endembed %}
</div>
